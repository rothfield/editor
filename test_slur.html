<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slur Functionality Test</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background: #fff;
        }
        button:hover { background: #f0f0f0; }
        #testOutput {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Slur Functionality Test</h1>

    <div class="test-container">
        <h2>WASM Module Test</h2>
        <button onclick="testWASMModule()">Test WASM Module Loading</button>
        <button onclick="testSlurAPI()">Test Slur API Functions</button>
        <button onclick="testFullSlurWorkflow()">Test Full Slur Workflow</button>
        <button onclick="clearOutput()">Clear Output</button>
        <div id="testOutput"></div>
    </div>

    <script type="module">
        import init, {
            applySlur,
            removeSlur,
            hasSlurInSelection,
            parseText,
            SlurIndicator
        } from './pkg/editor_wasm.js';

        let wasmModule = null;

        function log(message, type = 'info') {
            const output = document.getElementById('testOutput');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<div class="test-result ${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        window.clearOutput = function() {
            document.getElementById('testOutput').innerHTML = '';
        };

        window.testWASMModule = async function() {
            try {
                log("Loading WASM module...");
                wasmModule = await init();
                log("✅ WASM module loaded successfully!", 'success');
                log(`Available functions: ${typeof applySlur}, ${typeof removeSlur}, ${typeof hasSlurInSelection}`);
                log(`SlurIndicator enum: ${JSON.stringify(SlurIndicator)}`);
            } catch (error) {
                log(`❌ Failed to load WASM module: ${error.message}`, 'error');
            }
        };

        window.testSlurAPI = function() {
            if (!wasmModule) {
                log("❌ WASM module not loaded. Please load WASM first.", 'error');
                return;
            }

            try {
                log("Testing Slur API functions...");

                // Create test cells: "1 2 3 4"
                const testText = "1234";
                const cells = parseText(testText, 1); // Number pitch system
                log(`✅ Parsed test text "${testText}" into ${cells.length} cells`);

                // Test initial state - no slurs
                const hasSlurInitial = hasSlurInSelection(cells, 0, cells.length);
                log(`Initial slur state: ${hasSlurInitial} (should be false)`);

                // Apply slur to first two cells
                const updatedCells = applySlur(cells, 0, 2);
                log(`✅ Applied slur to range 0-2`);

                // Check if slur was applied
                const hasSlurAfterApply = hasSlurInSelection(updatedCells, 0, 2);
                log(`Slur state after apply: ${hasSlurAfterApply} (should be true)`);

                // Check cell indicators
                log(`Cell 0 slurIndicator: ${updatedCells[0].slurIndicator} (should be 1 for SlurStart)`);
                log(`Cell 1 slurIndicator: ${updatedCells[1].slurIndicator} (should be 2 for SlurEnd)`);
                log(`Cell 2 slurIndicator: ${updatedCells[2].slurIndicator} (should be 0 for None)`);
                log(`Cell 3 slurIndicator: ${updatedCells[3].slurIndicator} (should be 0 for None)`);

                // Test removing slur
                const cellsAfterRemove = removeSlur(updatedCells, 0, 2);
                log(`✅ Removed slur from range 0-2`);

                // Check if slur was removed
                const hasSlurAfterRemove = hasSlurInSelection(cellsAfterRemove, 0, 2);
                log(`Slur state after remove: ${hasSlurAfterRemove} (should be false)`);

                // Verify all indicators are cleared
                cellsAfterRemove.forEach((cell, index) => {
                    log(`Cell ${index} slurIndicator after removal: ${cell.slurIndicator} (should be 0)`);
                });

                log("✅ All Slur API tests passed!", 'success');

            } catch (error) {
                log(`❌ Slur API test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        };

        window.testFullSlurWorkflow = function() {
            if (!wasmModule) {
                log("❌ WASM module not loaded. Please load WASM first.", 'error');
                return;
            }

            try {
                log("Testing full slur workflow...");

                // Create more complex test: "S r R g G" (Sargam)
                const testText = "S rR gG";
                const cells = parseText(testText, 3); // Sargam pitch system
                log(`✅ Parsed Sargam text "${testText}" into ${cells.length} cells`);

                // Display cell details
                cells.forEach((cell, index) => {
                    log(`Cell ${index}: "${cell.glyph}" (kind: ${cell.kind}, slurIndicator: ${cell.slurIndicator})`);
                });

                // Apply slur to "r R" (cells 1-2)
                const cellsWithSlur = applySlur(cells, 1, 3);
                log(`✅ Applied slur to "r R" (cells 1-2)`);

                // Verify slur indicators
                log(`Cell 1 "${cellsWithSlur[1].glyph}" slurIndicator: ${cellsWithSlur[1].slurIndicator} (should be 1)`);
                log(`Cell 2 "${cellsWithSlur[2].glyph}" slurIndicator: ${cellsWithSlur[2].slurIndicator} (should be 2)`);

                // Test character insertion with slur preservation
                log("Testing character insertion with slur preservation...");

                // Insert a character after the slur
                const insertResult = wasmModule.insertCharacter(cellsWithSlur, 'M', 3, 3);
                log(`✅ Inserted 'M' at position 3, new total cells: ${insertResult.length}`);

                // Check if slur indicators are preserved
                const hasSlurAfterInsert = hasSlurInSelection(insertResult, 1, 3);
                log(`Slur preserved after insertion: ${hasSlurAfterInsert} (should be true)`);

                // Test character deletion with slur preservation
                log("Testing character deletion with slur preservation...");

                // Delete the inserted character
                const deleteResult = wasmModule.deleteCharacter(insertResult, 3);
                log(`✅ Deleted character at position 3, new total cells: ${deleteResult.length}`);

                // Check if slur indicators are preserved
                const hasSlurAfterDelete = hasSlurInSelection(deleteResult, 1, 3);
                log(`Slur preserved after deletion: ${hasSlurAfterDelete} (should be true)`);

                log("✅ Full slur workflow test completed!", 'success');

            } catch (error) {
                log(`❌ Full workflow test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        };

        // Auto-load WASM when page loads
        testWASMModule();
    </script>
</body>
</html>