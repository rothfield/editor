<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Return Key Functionality</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #0066cc;
            font-size: 1.2em;
            margin-top: 20px;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-left: 3px solid #0066cc;
        }
        .test-item.pass {
            border-left-color: #28a745;
            background: #f0f8f0;
        }
        .test-item.fail {
            border-left-color: #dc3545;
            background: #f8f0f0;
        }
        .code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Return Key Implementation - Test Plan</h1>

        <div class="test-section">
            <h2>Implementation Summary</h2>
            <p>Added standard Return/Enter key functionality to split lines at cursor position.</p>
            <ul>
                <li><strong>JavaScript side:</strong> Added <code class="code">handleEnter()</code> method + routing in <code class="code">handleNormalKey</code></li>
                <li><strong>Rust/WASM side:</strong> Added <code class="code">splitLineAtPosition()</code> function in <code class="code">src/api.rs</code></li>
                <li><strong>Behavior:</strong> Splits current line at cursor, moves content after cursor to new line</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>Manual Test Scenarios</h2>

            <div class="test-item">
                <strong>Test 1: Split at start of line</strong>
                <p>Precondition: Cursor at position 0 of a line with content "123"</p>
                <p>Action: Press Return</p>
                <p>Expected:
                    <ul>
                        <li>Old line: empty (0 cells)</li>
                        <li>New line: "123" (3 cells)</li>
                        <li>Cursor moves to new line (stave+1, column 0)</li>
                    </ul>
                </p>
            </div>

            <div class="test-item">
                <strong>Test 2: Split in middle of line</strong>
                <p>Precondition: Cursor at position 2 of line with content "12345"</p>
                <p>Action: Press Return</p>
                <p>Expected:
                    <ul>
                        <li>Old line: "12" (2 cells)</li>
                        <li>New line: "345" (3 cells)</li>
                        <li>Cursor at new line (stave+1, column 0)</li>
                    </ul>
                </p>
            </div>

            <div class="test-item">
                <strong>Test 3: Split at end of line</strong>
                <p>Precondition: Cursor at end of line with content "123"</p>
                <p>Action: Press Return</p>
                <p>Expected:
                    <ul>
                        <li>Old line: "123" (3 cells)</li>
                        <li>New line: empty (0 cells)</li>
                        <li>Cursor at new line (stave+1, column 0)</li>
                    </ul>
                </p>
            </div>

            <div class="test-item">
                <strong>Test 4: Musical properties inheritance</strong>
                <p>Precondition: Current line has pitch_system=Western, tonic="C", tala="4"</p>
                <p>Action: Press Return to split line</p>
                <p>Expected:
                    <ul>
                        <li>New line inherits: pitch_system=Western, tonic="C"</li>
                        <li>New line has empty: label="", lyrics="", tala=""</li>
                    </ul>
                </p>
            </div>

            <div class="test-item">
                <strong>Test 5: Selection prevention</strong>
                <p>Precondition: User has selected cells (has active selection)</p>
                <p>Action: Press Return</p>
                <p>Expected:
                    <ul>
                        <li>Warning shown: "Cannot split line with active selection"</li>
                        <li>Line not split</li>
                        <li>Undo not yet implemented message shown</li>
                    </ul>
                </p>
            </div>

            <div class="test-item">
                <strong>Test 6: Multiple consecutive splits</strong>
                <p>Precondition: Single line "1234", cursor at position 1</p>
                <p>Action: Press Return, then Return again on new line</p>
                <p>Expected:
                    <ul>
                        <li>After first Return: "1" on line 0, "234" on line 1</li>
                        <li>After second Return: "1" on line 0, "" on line 1, "234" on line 2</li>
                        <li>All new lines inherit same pitch system</li>
                    </ul>
                </p>
            </div>

            <div class="test-item">
                <strong>Test 7: Cursor positioning after split</strong>
                <p>Precondition: Line with content, cursor anywhere</p>
                <p>Action: Press Return</p>
                <p>Expected:
                    <ul>
                        <li>Cursor is at new line (stave index += 1)</li>
                        <li>Cursor column position is 0 (start of new line)</li>
                        <li>Can immediately start typing to add content to new line</li>
                    </ul>
                </p>
            </div>

            <div class="test-item">
                <strong>Test 8: Beat recalculation</strong>
                <p>Precondition: Line with musical content and beats calculated</p>
                <p>Action: Press Return to split line</p>
                <p>Expected:
                    <ul>
                        <li>Beats recalculated for both old line and new line</li>
                        <li>No errors in console</li>
                        <li>Notation updates correctly in renderer</li>
                    </ul>
                </p>
            </div>
        </div>

        <div class="test-section">
            <h2>Code Changes</h2>
            <h3>Rust (src/api.rs lines 1100-1191)</h3>
            <p>Added <code class="code">splitLineAtPosition()</code> WASM function that:</p>
            <ul>
                <li>Takes document, stave index, and character position</li>
                <li>Converts character position to cell index</li>
                <li>Splits cells array at split point</li>
                <li>Creates new line with inherited properties</li>
                <li>Inserts new line after current stave</li>
            </ul>

            <h3>JavaScript (src/js/editor.js)</h3>
            <ul>
                <li>Lines 814-816: Added <code class="code">case 'Enter': this.handleEnter(); break;</code> in <code class="code">handleNormalKey()</code></li>
                <li>Lines 1480-1554: Added <code class="code">handleEnter()</code> method that:
                    <ul>
                        <li>Checks for active selection and returns early if found</li>
                        <li>Calls WASM <code class="code">splitLineAtPosition()</code></li>
                        <li>Updates cursor to new line (stave+1, column 0)</li>
                        <li>Derives beats for both affected lines</li>
                        <li>Re-renders and updates display</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="test-section">
            <h2>How to Test</h2>
            <ol>
                <li>Start dev server: <code class="code">npm run dev</code></li>
                <li>Open browser to http://localhost:8080/</li>
                <li>Enter some notes (e.g., "123")</li>
                <li>Position cursor at various positions</li>
                <li>Press Return key</li>
                <li>Verify line splits and cursor moves correctly</li>
                <li>Check console for debug logs with [WASM] prefix</li>
            </ol>
        </div>
    </div>
</body>
</html>
