<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Staff Grouping – Gutter Context Menu Mock</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 20px;
        background: #f6f6f6;
      }

      h1 {
        font-size: 18px;
        margin-bottom: 8px;
      }

      p {
        font-size: 13px;
        max-width: 720px;
        color: #444;
      }

      .editor {
        position: relative;
        max-width: 540px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        padding: 6px 0;
      }

      .line-row {
        position: relative;
        display: flex;
        align-items: center;
        font-size: 13px;
        line-height: 1.3;
        padding: 2px 8px;
      }

      .line-row:hover {
        background: #f1f5ff;
      }

      .gutter {
        width: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: default;
        user-select: none;
        font-size: 14px;
        color: #666;
      }

      .label {
        flex: 1;
        padding-left: 4px;
      }

      .role-melody .label {
        font-weight: 400;
        padding-left: 12px; /* align with bullets */
      }

      .role-group-header .label {
        font-weight: 600;
      }

      .role-group-item .label {
        padding-left: 24px; /* indent under header */
      }

      /* Simple “outline” feel: vertical bar for group items */
      .role-group-item::before {
        content: "";
        position: absolute;
        left: 38px;
        top: 0;
        bottom: 0;
        border-left: 1px solid #ccc;
      }

      .role-group-header .gutter {
        color: #0057b8;
      }

      .role-group-header .gutter::before {
        content: "G"; /* Staff Group */
        font-size: 11px;
      }

      .role-group-item .gutter::before {
        content: "•"; /* Group item */
        font-size: 12px;
      }

      .role-melody .gutter::before {
        content: "M"; /* Melody (standalone) */
        font-size: 11px;
      }

      /* Bracket-ish overlay spanning a group (header + items) */
      .group-bracket {
        position: absolute;
        left: 20px;
        width: 8px;
        border-left: 2px solid #0057b8;
        border-radius: 4px;
        pointer-events: none;
      }

      .group-bracket-cap-top,
      .group-bracket-cap-bottom {
        position: absolute;
        left: 20px;
        width: 8px;
        height: 8px;
        border-left: 2px solid #0057b8;
        pointer-events: none;
      }

      .group-bracket-cap-top {
        border-top: 2px solid #0057b8;
        border-radius: 4px 0 0 0;
      }

      .group-bracket-cap-bottom {
        border-bottom: 2px solid #0057b8;
        border-radius: 0 0 0 4px;
      }

      /* Custom context menu */
      .context-menu {
        position: absolute;
        z-index: 1000;
        background: #ffffff;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        min-width: 180px;
        padding: 4px 0;
        font-size: 13px;
        display: none;
      }

      .context-menu-item {
        padding: 4px 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .context-menu-item:hover {
        background: #eef6ff;
      }

      .context-menu-radio {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 1px solid #888;
        display: inline-block;
        box-sizing: border-box;
      }

      .context-menu-radio.checked {
        background: #0057b8;
        border-color: #0057b8;
      }
    </style>
  </head>
  <body>
    <h1>Staff Grouping – Gutter Context Menu Mock</h1>
    <p>
      Right-click the <b>gutter</b> (left column) on any line to set its role:
      <i>Melody</i> (standalone staff), <i>Staff group</i> (group header), or
      <i>Group item</i> (member of the nearest group above).
      The layout and simple bracket visuals update automatically.
    </p>

    <div class="editor" id="editor">
      <div class="line-row role-group-header" data-role="group-header">
        <div class="gutter"></div>
        <div class="label">Piano</div>
      </div>
      <div class="line-row role-group-item" data-role="group-item">
        <div class="gutter"></div>
        <div class="label">Piano RH</div>
      </div>
      <div class="line-row role-group-item" data-role="group-item">
        <div class="gutter"></div>
        <div class="label">Piano LH</div>
      </div>
      <div class="line-row role-melody" data-role="melody">
        <div class="gutter"></div>
        <div class="label">Melody</div>
      </div>
      <div class="line-row role-group-header" data-role="group-header">
        <div class="gutter"></div>
        <div class="label">Choir</div>
      </div>
      <div class="line-row role-group-item" data-role="group-item">
        <div class="gutter"></div>
        <div class="label">Soprano</div>
      </div>
      <div class="line-row role-group-item" data-role="group-item">
        <div class="gutter"></div>
        <div class="label">Alto</div>
      </div>
      <div class="line-row role-group-item" data-role="group-item">
        <div class="gutter"></div>
        <div class="label">Tenor</div>
      </div>
      <div class="line-row role-group-item" data-role="group-item">
        <div class="gutter"></div>
        <div class="label">Bass</div>
      </div>
    </div>

    <!-- Custom context menu -->
    <div class="context-menu" id="ctxMenu">
      <div class="context-menu-item" data-choice="melody">
        <span class="context-menu-radio" data-radio="melody"></span>
        Melody (standalone staff)
      </div>
      <div class="context-menu-item" data-choice="group-header">
        <span class="context-menu-radio" data-radio="group-header"></span>
        Staff group (group header)
      </div>
      <div class="context-menu-item" data-choice="group-item">
        <span class="context-menu-radio" data-radio="group-item"></span>
        Group item (member of group above)
      </div>
    </div>

    <script>
      const editor = document.getElementById("editor");
      const ctxMenu = document.getElementById("ctxMenu");
      let ctxTargetRow = null;

      const ROLE_CLASS_MAP = {
        "melody": "role-melody",
        "group-header": "role-group-header",
        "group-item": "role-group-item",
      };

      function setRowRole(row, role) {
        // Remove old role class
        Object.values(ROLE_CLASS_MAP).forEach(c => row.classList.remove(c));
        // Set new role
        row.dataset.role = role;
        row.classList.add(ROLE_CLASS_MAP[role]);
      }

      function updateBrackets() {
        // Remove old bracket overlays
        editor.querySelectorAll(".group-bracket, .group-bracket-cap-top, .group-bracket-cap-bottom")
          .forEach(el => el.remove());

        const rows = Array.from(editor.querySelectorAll(".line-row"));

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (row.dataset.role === "group-header") {
            // Collect contiguous group-item rows below
            let startIdx = i;
            let endIdx = i;
            for (let j = i + 1; j < rows.length; j++) {
              if (rows[j].dataset.role === "group-item") {
                endIdx = j;
              } else {
                break;
              }
            }
            if (endIdx > startIdx) {
              drawBracket(startIdx, endIdx, rows);
            }
          }
        }
      }

      function drawBracket(startIdx, endIdx, rows) {
        const first = rows[startIdx];
        const last = rows[endIdx];

        const editorRect = editor.getBoundingClientRect();
        const firstRect = first.getBoundingClientRect();
        const lastRect = last.getBoundingClientRect();

        const top = firstRect.top - editorRect.top;
        const bottom = lastRect.bottom - editorRect.top;
        const height = bottom - top;

        const bracket = document.createElement("div");
        bracket.className = "group-bracket";
        bracket.style.top = top + "px";
        bracket.style.height = height + "px";
        editor.appendChild(bracket);

        const capTop = document.createElement("div");
        capTop.className = "group-bracket-cap-top";
        capTop.style.top = top + "px";
        editor.appendChild(capTop);

        const capBottom = document.createElement("div");
        capBottom.className = "group-bracket-cap-bottom";
        capBottom.style.top = (bottom - 8) + "px";
        editor.appendChild(capBottom);
      }

      // Show context menu on right-click in gutter
      editor.addEventListener("contextmenu", (e) => {
        const gutter = e.target.closest(".gutter");
        if (!gutter) return; // allow default context menu elsewhere

        e.preventDefault();
        ctxTargetRow = gutter.closest(".line-row");
        if (!ctxTargetRow) return;

        const role = ctxTargetRow.dataset.role;

        // Position menu
        ctxMenu.style.display = "block";
        ctxMenu.style.left = e.pageX + "px";
        ctxMenu.style.top = e.pageY + "px";

        // Update radio visuals
        ctxMenu.querySelectorAll(".context-menu-radio").forEach(r => {
          r.classList.remove("checked");
        });
        const radio = ctxMenu.querySelector(`[data-radio="${role}"]`);
        if (radio) radio.classList.add("checked");
      });

      // Handle menu choice
      ctxMenu.addEventListener("click", (e) => {
        const item = e.target.closest(".context-menu-item");
        if (!item || !ctxTargetRow) return;

        const choice = item.dataset.choice;
        if (choice === "melody") {
          setRowRole(ctxTargetRow, "melody");
        } else if (choice === "group-header") {
          setRowRole(ctxTargetRow, "group-header");
        } else if (choice === "group-item") {
          // Find nearest group-header above
          const rows = Array.from(editor.querySelectorAll(".line-row"));
          const idx = rows.indexOf(ctxTargetRow);
          let header = null;
          for (let i = idx - 1; i >= 0; i--) {
            if (rows[i].dataset.role === "group-header") {
              header = rows[i];
              break;
            }
            if (rows[i].dataset.role === "melody") {
              break; // stop at standalone staff
            }
          }
          if (!header) {
            alert("No staff group above this line. Set a 'Staff group' line above first.");
          } else {
            setRowRole(ctxTargetRow, "group-item");
          }
        }

        ctxMenu.style.display = "none";
        ctxTargetRow = null;
        updateBrackets();

        // In your real app, this is where you'd call into WASM, e.g.:
        // wasm.handle_command({ kind: "set_line_role", line_id, role: choice });
      });

      // Hide menu on click outside or scroll
      document.addEventListener("click", (e) => {
        if (!ctxMenu.contains(e.target)) {
          ctxMenu.style.display = "none";
          ctxTargetRow = null;
        }
      });
      window.addEventListener("scroll", () => {
        ctxMenu.style.display = "none";
        ctxTargetRow = null;
      });

      // Initial bracket layout
      updateBrackets();
    </script>
  </body>
</html>

