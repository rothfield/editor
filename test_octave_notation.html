<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Octave Notation Test</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .instructions {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }
        #notation-canvas {
            border: 1px solid #ddd;
            background: white;
            min-height: 80px;
            padding: 10px;
            font-family: monospace;
            font-size: 16px;
            line-height: 16px;
            position: relative;
        }
        .controls {
            margin-top: 15px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
            font-size: 12px;
        }
        button:hover {
            background: #0052a3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-title">Octave Notation Test - Small Black Dots</div>
        <div class="instructions">
            This test verifies that octave markings are displayed as small black dots above and below musical glyphs.
            <br><br>
            <strong>Test Data:</strong> "1 2 3" where:
            <ul>
                <li>"1" has octave +1 (dot above)</li>
                <li>"2" has octave -1 (dot below)</li>
                <li>"3" has no octave (no dots)</li>
            </ul>
            <strong>Expected Result:</strong> Black dots positioned above "1" and below "2", with "3" having no dots.
        </div>

        <div id="notation-canvas">
            <!-- Notation will be rendered here -->
        </div>

        <div class="controls">
            <button onclick="renderOctaveTest()">Render Octave Test</button>
            <button onclick="clearCanvas()">Clear</button>
            <button onclick="showDebugInfo()">Show Debug Info</button>
        </div>

        <div id="status"></div>
    </div>

    <script type="module">
        // Mock DOMRenderer class for testing
        class MockDOMRenderer {
            constructor(canvas) {
                this.canvas = canvas;
                this.octaveCanvas = null;
                this.octaveCtx = null;
                this.setupOctaveCanvas();
            }

            setupOctaveCanvas() {
                this.octaveCanvas = document.createElement('canvas');
                this.octaveCanvas.className = 'octave-canvas-overlay';
                this.octaveCanvas.style.position = 'absolute';
                this.octaveCanvas.style.top = '0';
                this.octaveCanvas.style.left = '0';
                this.octaveCanvas.style.pointerEvents = 'none';
                this.octaveCanvas.style.width = '100%';
                this.octaveCanvas.style.height = '100%';
                this.octaveCanvas.style.zIndex = '2';

                this.canvas.appendChild(this.octaveCanvas);
                this.octaveCtx = this.octaveCanvas.getContext('2d');

                // Set canvas size
                const rect = this.canvas.getBoundingClientRect();
                this.octaveCanvas.width = rect.width;
                this.octaveCanvas.height = rect.height;
            }

            renderOctaveDot(charCell, lineIndex, laneIndex, cellIndex) {
                const ctx = this.octaveCtx;

                // Calculate position with proper lane offsets
                const laneOffsets = [0, 16, 32, 48];
                const laneOffset = laneOffsets[laneIndex] || 16;

                const centerX = (charCell.x || (cellIndex * 12)) + (charCell.w || 12) / 2;
                const baseY = laneOffset + (charCell.y || 0);

                // Determine dot position based on octave value
                let dotY, dotCount;

                switch (charCell.octave) {
                    case 1: // Octave up - dot above
                        dotY = baseY - 12; // 12px above element
                        dotCount = 1;
                        break;
                    case 2: // Two octaves up - two dots above
                        dotY = baseY - 12;
                        dotCount = 2;
                        break;
                    case -1: // Octave down - dot below
                        dotY = baseY + 20; // 20px below element
                        dotCount = 1;
                        break;
                    case -2: // Two octaves down - two dots below
                        dotY = baseY + 20;
                        dotCount = 2;
                        break;
                    default:
                        return; // No octave marking for octave 0
                }

                // Set dot styling - small black circles as requested
                ctx.fillStyle = '#000000'; // Black dots
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;

                // Draw dots based on count
                for (let i = 0; i < dotCount; i++) {
                    const offsetX = centerX + (i - (dotCount - 1) / 2) * 6; // Space dots 6px apart

                    // Draw filled circle (small black dot)
                    ctx.beginPath();
                    ctx.arc(offsetX, dotY, 2, 0, Math.PI * 2);
                    ctx.fill();

                    // Add subtle border for better visibility
                    ctx.beginPath();
                    ctx.arc(offsetX, dotY, 2.5, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // Add small connecting line for multiple dots (visual enhancement)
                if (dotCount > 1) {
                    ctx.beginPath();
                    const firstDotX = centerX + (0 - (dotCount - 1) / 2) * 6;
                    const lastDotX = centerX + ((dotCount - 1) - (dotCount - 1) / 2) * 6;
                    ctx.moveTo(firstDotX, dotY);
                    ctx.lineTo(lastDotX, dotY);
                    ctx.stroke();
                }
            }

            renderTestDocument() {
                // Clear octave canvas
                this.octaveCtx.clearRect(0, 0, this.octaveCanvas.width, this.octaveCanvas.height);

                // Test data: cells with different octave markings
                const testCells = [
                    { grapheme: '1', x: 0, y: 0, w: 12, h: 16, octave: 1 },  // Octave up (dot above)
                    { grapheme: '2', x: 24, y: 0, w: 12, h: 16, octave: -1 }, // Octave down (dot below)
                    { grapheme: '3', x: 48, y: 0, w: 12, h: 16, octave: 0 },  // No octave (no dots)
                ];

                // Render octave dots for test cells
                testCells.forEach((cell, index) => {
                    if (cell.octave !== 0) {
                        this.renderOctaveDot(cell, 0, 1, index);
                    }
                });

                return testCells;
            }
        }

        // Global functions for button clicks
        window.renderOctaveTest = function() {
            const canvas = document.getElementById('notation-canvas');
            const status = document.getElementById('status');

            try {
                // Clear canvas first
                canvas.innerHTML = '';

                // Add text content
                const textContent = document.createElement('div');
                textContent.style.cssText = `
                    position: absolute;
                    left: 10px;
                    top: 10px;
                    font-size: 16px;
                    font-family: monospace;
                    z-index: 1;
                `;
                textContent.textContent = '1 2 3';
                canvas.appendChild(textContent);

                // Create renderer and render octave dots
                const renderer = new MockDOMRenderer(canvas);
                const renderedCells = renderer.renderTestDocument();

                // Show success status
                status.className = 'status success';
                status.innerHTML = `
                    <strong>✓ Success:</strong> Octave dots rendered correctly.<br>
                    • Cell "1" (index 0): Octave +1 - dot should appear above<br>
                    • Cell "2" (index 1): Octave -1 - dot should appear below<br>
                    • Cell "3" (index 2): Octave 0 - no dots<br>
                    <small>Dots are rendered as small black circles using canvas.</small>
                `;

                console.log('Octave test rendered successfully:', renderedCells);

            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `<strong>✗ Error:</strong> ${error.message}`;
                console.error('Octave test failed:', error);
            }
        };

        window.clearCanvas = function() {
            const canvas = document.getElementById('notation-canvas');
            const status = document.getElementById('status');

            canvas.innerHTML = '';
            status.innerHTML = '';
            status.className = '';
        };

        window.showDebugInfo = function() {
            const canvas = document.getElementById('notation-canvas');
            const octaveCanvas = canvas.querySelector('.octave-canvas-overlay');

            if (octaveCanvas) {
                console.log('Octave canvas info:', {
                    width: octaveCanvas.width,
                    height: octaveCanvas.height,
                    style: octaveCanvas.style.cssText,
                    context: !!octaveCanvas.getContext('2d')
                });
            } else {
                console.log('No octave canvas found - render test first');
            }
        };

        // Auto-render on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                renderOctaveTest();
            }, 100);
        });
    </script>
</body>
</html>