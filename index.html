<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Music Notation Editor POC - CharCell-based musical notation editing">
    <title>Music Notation Editor - POC</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="dist/main.css">

    <!-- Preload critical resources -->
    <link rel="preload" href="dist/pkg/ecs_editor_wasm.js" as="script">
    <link rel="preload" href="dist/pkg/ecs_editor_wasm_bg.wasm" as="fetch" crossorigin>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â™«</text></svg>">
</head>
<body class="bg-ui-background text-notation-text font-sans antialiased">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header with Title -->
        <header class="bg-white border-b border-ui-border px-4 py-3">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-semibold text-notation-text">
                    Music Notation Editor <span class="text-sm text-ui-disabled-text">POC</span>
                </h1>
                <div id="composition-title" class="text-sm text-ui-disabled-text">
                    Untitled Document
                </div>
            </div>
        </header>

        <!-- Menu Bar -->
        <nav class="bg-white border-b border-ui-border px-2 py-1">
            <ul class="flex space-x-1">
                <!-- File Menu -->
                <li class="relative">
                    <button id="file-menu-button" class="menu-item px-3 py-1 rounded text-sm hover:bg-ui-hover">
                        File
                    </button>
                    <ul id="file-menu" class="absolute top-full left-0 bg-white border border-ui-border rounded shadow-lg hidden z-menu">
                        <li><button id="menu-new" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">New</button></li>
                        <li><button id="menu-open" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Open...</button></li>
                        <li><button id="menu-save" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Save...</button></li>
                        <li class="border-t border-ui-border"><hr class="my-1"></li>
                        <li><button id="menu-export-musicxml" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Export MusicXML...</button></li>
                        <li><button id="menu-export-lilypond" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Export LilyPond...</button></li>
                        <li class="border-t border-ui-border"><hr class="my-1"></li>
                        <li><button id="menu-set-title" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Title...</button></li>
                        <li><button id="menu-set-tonic" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Tonic...</button></li>
                        <li><button id="menu-set-pitch-system" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Pitch System...</button></li>
                        <li><button id="menu-set-key-signature" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Key Signature...</button></li>
                    </ul>
                </li>

                <!-- Line Menu -->
                <li class="relative">
                    <button id="line-menu-button" class="menu-item px-3 py-1 rounded text-sm hover:bg-ui-hover">
                        Line
                    </button>
                    <ul id="line-menu" class="absolute top-full left-0 bg-white border border-ui-border rounded shadow-lg hidden z-menu">
                        <li><button id="menu-set-label" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Label...</button></li>
                        <li><button id="menu-set-tonic" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Tonic...</button></li>
                        <li><button id="menu-set-pitch-system" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Pitch System...</button></li>
                        <li><button id="menu-set-lyrics" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Lyrics...</button></li>
                        <li><button id="menu-set-tala" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Tala...</button></li>
                        <li><button id="menu-set-key-signature" class="menu-item block w-full text-left px-3 py-1 text-sm whitespace-nowrap">Set Key Signature...</button></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 flex">
            <!-- Editor Canvas -->
            <section class="flex-1 flex flex-col">
                <div id="editor-container" class="flex-1 relative overflow-auto p-4">
                    <!-- Notation Canvas -->
                    <div id="notation-canvas"
                         class="notation-canvas focusable"
                         tabindex="0"
                         role="textbox"
                         aria-label="Music notation editor"
                         aria-multiline="false"
                         spellcheck="false">
                        <!-- CharCell elements will be dynamically added here -->
                        <div class="notation-line" id="notation-line">
                            <div class="text-ui-disabled-text text-sm">Click to start entering musical notation...</div>
                        </div>
                    </div>

                    <!-- Slur rendering canvas overlay -->
                    <canvas id="slur-canvas" class="absolute top-0 left-0 pointer-events-none z-slur" style="display: none;"></canvas>
                </div>

                <!-- Status Bar -->
                <footer class="bg-ui-background border-t border-ui-border px-4 py-2">
                    <div class="flex items-center justify-between text-xs text-ui-disabled-text">
                        <div class="flex items-center space-x-4">
                            <span>Position: <span id="cursor-position">0</span></span>
                            <span>Pitch System: <span id="current-pitch-system">Number</span></span>
                            <span>Characters: <span id="char-count">0</span></span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="focus-status" class="text-ui-disabled-text">No focus</span>
                            <span id="performance-indicator" class="text-success hidden">Ready</span>
                        </div>
                    </div>
                </footer>
            </section>

            <!-- Debug Information Panel -->
            <aside class="w-96 bg-ui-background border-l border-ui-border flex flex-col">
                <!-- Tab Navigation -->
                <div class="bg-white border-b border-ui-border">
                    <nav class="flex">
                        <button id="tab-document" class="tab active" data-tab="document">
                            Document
                        </button>
                        <button id="tab-console-errors" class="tab" data-tab="console-errors">
                            Console Errors
                        </button>
                        <button id="tab-console-log" class="tab" data-tab="console-log">
                            Console Log
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="flex-1 overflow-auto">
                    <!-- Document Tab -->
                    <div id="tab-content-document" class="tab-content p-4">
                        <h3 class="text-sm font-semibold mb-2">Document Structure</h3>
                        <pre id="document-json" class="text-xs font-mono bg-white p-2 rounded border border-ui-border overflow-auto max-h-96"></pre>
                    </div>

                    <!-- Console Errors Tab -->
                    <div id="tab-content-console-errors" class="tab-content hidden p-4">
                        <h3 class="text-sm font-semibold mb-2">Console Errors</h3>
                        <div id="console-errors-list" class="space-y-1 max-h-96 overflow-auto">
                            <div class="text-sm text-ui-disabled-text">No errors</div>
                        </div>
                    </div>

                    <!-- Console Log Tab -->
                    <div id="tab-content-console-log" class="tab-content hidden p-4">
                        <h3 class="text-sm font-semibold mb-2">Console Log</h3>
                        <div id="console-log-list" class="space-y-1 max-h-96 overflow-auto">
                            <div class="text-sm text-ui-disabled-text">No logs</div>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- JavaScript Modules -->
    <script type="module" src="dist/main.js"></script>

    <!-- Error handling for script loading -->
    <script>
        // Handle WASM loading errors
        window.addEventListener('error', function(event) {
            if (event.filename && event.filename.includes('wasm')) {
                console.error('WASM loading failed:', event.error);
                const canvas = document.getElementById('notation-canvas');
                if (canvas) {
                    canvas.innerHTML = '<div class="error">Failed to load music notation engine. Please refresh the page.</div>';
                }
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            const errorsList = document.getElementById('console-errors-list');
            if (errorsList) {
                const errorEntry = document.createElement('div');
                errorEntry.className = 'error text-sm';
                errorEntry.innerHTML = `
                    <span class="text-error">${new Date().toLocaleTimeString()}</span>
                    <span class="font-semibold">PROMISE REJECTION:</span>
                    <span>${event.reason?.message || event.reason}</span>
                `;
                errorsList.appendChild(errorEntry);
            }
        });
    </script>
</body>
</html>