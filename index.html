<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Music Notation Editor POC - Cell-based musical notation editing">
    <title>Music Notation Editor - POC</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="dist/main.css">

    <!-- Custom UI styles -->
    <style>
        /* Music Fonts */
        @font-face {
            font-family: 'Bravura';
            src: url('/static/fonts/Bravura.woff2') format('woff2'),
                 url('/static/fonts/Bravura.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Inter';
            src: url('/static/fonts/Inter.ttc') format('truetype-collection');
            font-weight: 100 900;
            font-style: normal;
            font-display: swap;
        }

        /* Viewport constraints - prevent scrollbars */
        html, body {
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        /* Remove list bullets */
        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        nav ul li {
            list-style: none;
        }

        /* Tab buttons container */
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            gap: 0;
        }

        /* Tab styling */
        .tab {
            padding: 0.375rem 0.5rem;
            border: 1px solid #e5e7eb;
            border-bottom: 2px solid transparent;
            background: #f9fafb;
            text-align: center;
            cursor: pointer;
            font-size: 0.65rem;
            white-space: nowrap;
            transition: all 0.2s;
            flex: 0 1 auto;
            min-width: min-content;
        }

        .tab:hover {
            background: #f3f4f6;
        }

        /* Tab active state */
        .tab.active {
            border-bottom-color: #0066cc;
            background: white;
            color: #0066cc;
            font-weight: 500;
        }

        /* Menu styling */
        .z-menu {
            z-index: 1000;
        }

        .menu-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .menu-item:hover {
            background-color: #f3f4f6;
        }

        /* Menu button active state */
        button.bg-ui-active {
            background-color: #e5e7eb;
        }

        /* Tab container */
        .tab {
            position: relative;
        }

        /* Resize handle */
        #resize-handle {
            position: relative;
        }

        #resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 40px;
            background: linear-gradient(to bottom,
                transparent 0%,
                #9ca3af 20%,
                #9ca3af 80%,
                transparent 100%);
            border-radius: 2px;
            pointer-events: none;
        }

        #resize-handle:hover::before {
            background: linear-gradient(to bottom,
                transparent 0%,
                #3b82f6 20%,
                #3b82f6 80%,
                transparent 100%);
        }

        /* Ensure tab content areas scroll properly */
        .tab-content {
            min-height: 0; /* Critical for flex scrolling */
        }

        /* Scrollbar styling for tab content */
        #document-json,
        #persistent-json,
        #lilypond-source,
        #html-content,
        #console-errors-list,
        #console-log-list {
            overflow-y: auto !important;
            overflow-x: auto !important;
            min-height: 0; /* Critical for flex scrolling */
            max-height: 100%; /* Constrain to parent */
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f3f4f6;
        }

        /* HTML content wrapping */
        #html-content {
            white-space: pre-wrap;
            word-break: break-word;
            overflow-x: hidden !important;
        }

        /* Webkit scrollbar styling */
        #document-json::-webkit-scrollbar,
        #persistent-json::-webkit-scrollbar,
        #lilypond-source::-webkit-scrollbar,
        #html-content::-webkit-scrollbar,
        #console-errors-list::-webkit-scrollbar,
        #console-log-list::-webkit-scrollbar {
            width: 10px;
        }

        #document-json::-webkit-scrollbar-track,
        #persistent-json::-webkit-scrollbar-track,
        #lilypond-source::-webkit-scrollbar-track,
        #html-content::-webkit-scrollbar-track,
        #console-errors-list::-webkit-scrollbar-track,
        #console-log-list::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }

        #document-json::-webkit-scrollbar-thumb,
        #persistent-json::-webkit-scrollbar-thumb,
        #lilypond-source::-webkit-scrollbar-thumb,
        #html-content::-webkit-scrollbar-thumb,
        #console-errors-list::-webkit-scrollbar-thumb,
        #console-log-list::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }

        #document-json::-webkit-scrollbar-thumb:hover,
        #persistent-json::-webkit-scrollbar-thumb:hover,
        #lilypond-source::-webkit-scrollbar-thumb:hover,
        #html-content::-webkit-scrollbar-thumb:hover,
        #console-errors-list::-webkit-scrollbar-thumb:hover,
        #console-log-list::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Element kind styling */
        /* Default text font */
        .char-cell {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Music font for barlines and musical symbols */
        .char-cell.kind-barline {
            font-family: 'Bravura', serif;
            font-size: 20px;
            line-height: 1;
        }

        /* Text cells - italics and red */
        .char-cell.kind-text {
            font-style: italic;
            color: #ef4444; /* red-500 */
        }

        /* Pitched elements - bold */
        .char-cell.kind-pitched {
            font-weight: bold;
        }

        /* Unpitched elements - bold */
        .char-cell.kind-unpitched {
            font-weight: bold;
        }

        /* Selected cells */
        .char-cell.selected {
            background-color: rgba(59, 130, 246, 0.3); /* Blue with transparency */
        }
    </style>

    <!-- OSMD for staff notation rendering -->
    <script src="https://unpkg.com/opensheetmusicdisplay@1.7.6/build/opensheetmusicdisplay.min.js"></script>

    <!-- Preload critical resources -->
    <link rel="modulepreload" href="dist/pkg/editor_wasm.js">
    <link rel="preload" href="dist/pkg/editor_wasm_bg.wasm" as="fetch" crossorigin="anonymous">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>♫</text></svg>">
</head>
<body class="bg-ui-background text-notation-text font-sans antialiased">
    <div id="app" class="h-screen flex flex-col overflow-hidden">
        <!-- Header with Menu and Title -->
        <header class="bg-white border-b border-ui-border">
            <div class="flex items-center justify-between px-4 py-2">
                <!-- Left: Menu Bar -->
                <nav class="flex items-center space-x-4">
                    <ul class="flex space-x-1">
                        <!-- File Menu -->
                        <li class="relative">
                            <button id="file-menu-button" class="px-3 py-1 rounded text-sm hover:bg-ui-hover">
                                File
                            </button>
                            <ul id="file-menu" class="absolute top-full left-0 bg-white border border-ui-border rounded shadow-lg hidden z-menu min-w-48">
                                <li><button id="menu-new" class="menu-item">New</button></li>
                                <li><button id="menu-open" class="menu-item">Open...</button></li>
                                <li><button id="menu-save" class="menu-item">Save...</button></li>
                                <li class="border-t border-ui-border my-1"></li>
                                <li><button id="menu-export-musicxml" class="menu-item">Export MusicXML...</button></li>
                                <li><button id="menu-export-lilypond" class="menu-item">Export LilyPond...</button></li>
                                <li class="border-t border-ui-border my-1"></li>
                                <li><button id="menu-set-title" class="menu-item">Set Title...</button></li>
                                <li><button id="menu-set-tonic" class="menu-item">Set Tonic...</button></li>
                                <li><button id="menu-set-pitch-system" class="menu-item">Set Pitch System...</button></li>
                                <li><button id="menu-set-key-signature" class="menu-item">Set Key Signature...</button></li>
                            </ul>
                        </li>

                        <!-- Edit Menu -->
                        <li class="relative">
                            <button id="edit-menu-button" class="px-3 py-1 rounded text-sm hover:bg-ui-hover">
                                Edit
                            </button>
                            <ul id="edit-menu" class="absolute top-full left-0 bg-white border border-ui-border rounded shadow-lg hidden z-menu min-w-48">
                                <li><button id="menu-apply-slur" class="menu-item">Apply Slur (Alt+S)</button></li>
                                <li class="border-t border-ui-border my-1"></li>
                                <li><button id="menu-octave-upper" class="menu-item">Upper Octave (Alt+U)</button></li>
                                <li><button id="menu-octave-middle" class="menu-item">Middle Octave (Alt+M)</button></li>
                                <li><button id="menu-octave-lower" class="menu-item">Lower Octave (Alt+L)</button></li>
                            </ul>
                        </li>

                        <!-- Line Menu -->
                        <li class="relative">
                            <button id="line-menu-button" class="px-3 py-1 rounded text-sm hover:bg-ui-hover">
                                Line
                            </button>
                            <ul id="line-menu" class="absolute top-full left-0 bg-white border border-ui-border rounded shadow-lg hidden z-menu min-w-48">
                                <li><button id="menu-set-label" class="menu-item">Set Label...</button></li>
                                <li><button id="menu-set-tonic" class="menu-item">Set Tonic...</button></li>
                                <li><button id="menu-set-pitch-system" class="menu-item">Set Pitch System...</button></li>
                                <li><button id="menu-set-lyrics" class="menu-item">Set Lyrics...</button></li>
                                <li><button id="menu-set-tala" class="menu-item">Set Tala...</button></li>
                                <li><button id="menu-set-key-signature" class="menu-item">Set Key Signature...</button></li>
                            </ul>
                        </li>
                    </ul>
                </nav>

                <!-- Center: Document Status Information -->
                <div class="flex items-center space-x-4 text-xs text-gray-600">
                    <span>Position: <span id="cursor-position">Line: 0, Col: 0 (Lane: 1)</span></span>
                    <span class="text-gray-400">|</span>
                    <span>Pitch System: <span id="current-pitch-system">Number</span></span>
                    <span class="text-gray-400">|</span>
                    <span>Characters: <span id="char-count">0</span></span>
                    <span class="text-gray-400">|</span>
                    <span id="selection-info">No selection</span>
                </div>

                <!-- Right: Document Title -->
                <div id="composition-title" class="text-sm text-ui-disabled-text">
                    Untitled Document
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 flex overflow-hidden" id="main-container">
            <!-- Editor Canvas -->
            <section class="flex-1 flex flex-col overflow-hidden" id="editor-section">
                <div id="editor-container" class="flex-1 relative overflow-hidden p-4">
                    <!-- Notation Editor -->
                    <div id="notation-editor"
                         class="notation-editor focusable"
                         tabindex="0"
                         role="textbox"
                         aria-label="Music notation editor"
                         aria-multiline="false"
                         spellcheck="false">
                        <!-- Cell elements will be dynamically added here -->
                        <div class="notation-line" id="notation-line">
                            <div class="text-ui-disabled-text text-sm">Click to start entering musical notation...</div>
                        </div>
                    </div>
                </div>

                <!-- Status Bar -->
                <footer class="bg-ui-background border-t border-ui-border px-4 py-2">
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <div class="flex items-center space-x-4">
                            <span id="focus-status" class="text-gray-500">No focus</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="performance-indicator" class="text-success hidden">Ready</span>
                        </div>
                    </div>
                </footer>
            </section>

            <!-- Resize Handle -->
            <div id="resize-handle" class="w-4 bg-gray-300 hover:bg-blue-500 cursor-col-resize transition-colors flex-shrink-0"></div>

            <!-- Debug Information Panel -->
            <aside id="tabs-panel" class="bg-ui-background border-l border-ui-border flex flex-col overflow-hidden" style="width: 384px; min-width: 200px; max-width: 800px;">
                <!-- Tab Navigation (Multi-row wrap) -->
                <div class="bg-white border-b border-ui-border">
                    <div class="tab-buttons flex flex-wrap gap-0">
                        <button id="tab-staff-notation" class="tab active" data-tab="staff-notation">
                            Staff Notation
                        </button>
                        <button id="tab-musicxml" class="tab" data-tab="musicxml">
                            MusicXML
                        </button>
                        <button id="tab-lilypond-src" class="tab" data-tab="lilypond-src">
                            LilyPond Src
                        </button>
                        <button id="tab-lilypond-png" class="tab" data-tab="lilypond-png">
                            LilyPond PNG
                        </button>
                        <button id="tab-ephemeral" class="tab" data-tab="ephemeral">
                            Ephemeral Model
                        </button>
                        <button id="tab-persistent" class="tab" data-tab="persistent">
                            Persistent Model
                        </button>
                        <button id="tab-console-errors" class="tab" data-tab="console-errors">
                            Console Errors
                        </button>
                        <button id="tab-console-log" class="tab" data-tab="console-log">
                            Console Log
                        </button>
                        <button id="tab-html" class="tab" data-tab="html">
                            HTML
                        </button>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <!-- Staff Notation Tab -->
                    <div id="tab-content-staff-notation" data-tab-content="staff-notation" class="tab-content flex-1 flex flex-col p-4">
                        <div id="staff-notation-container" class="flex-1 bg-white p-4 border-2 border-gray-300 rounded overflow-auto mb-2">
                            <div class="text-sm text-gray-500">Start typing music to see staff notation...</div>
                        </div>

                        <!-- MIDI Playback Controls -->
                        <div class="bg-gray-50 border border-gray-300 rounded p-2">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <button id="midi-play" class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-xs" title="Play">
                                        ▶
                                    </button>
                                    <button id="midi-pause" class="px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-xs" title="Pause" disabled>
                                        ⏸
                                    </button>
                                    <button id="midi-stop" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-xs" title="Stop" disabled>
                                        ⏹
                                    </button>
                                    <span class="text-xs text-gray-600 ml-2">
                                        <input id="midi-tempo" type="number" min="40" max="208" value="120" class="w-12 px-1 py-0.5 border border-gray-300 rounded text-xs"> BPM
                                    </span>
                                    <span class="text-xs text-gray-600 ml-2 flex items-center space-x-1">
                                        <span>🔊</span>
                                        <input id="midi-volume" type="range" min="0" max="100" value="100" class="w-16" title="Volume">
                                        <span id="midi-volume-label" class="w-8">100%</span>
                                    </span>
                                </div>
                                <div class="flex items-center space-x-2 text-xs text-gray-600">
                                    <span id="midi-status">Ready</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MusicXML Tab -->
                    <div id="tab-content-musicxml" data-tab-content="musicxml" class="tab-content hidden flex-1 flex flex-col p-4">
                        <h3 class="text-sm font-semibold mb-2 text-gray-700">MusicXML Source</h3>
                        <pre id="musicxml-source" class="flex-1 text-xs font-mono bg-white p-3 border-2 border-gray-300 rounded overflow-auto"></pre>
                    </div>

                    <!-- LilyPond Source Code Tab -->
                    <div id="tab-content-lilypond-src" data-tab-content="lilypond-src" class="tab-content hidden flex-1 flex flex-col p-4">
                        <pre id="lilypond-source" class="flex-1 text-xs font-mono bg-white p-3 border-2 border-gray-300 rounded overflow-auto"></pre>
                    </div>

                    <!-- LilyPond PNG/SVG Rendering Tab -->
                    <div id="tab-content-lilypond-png" data-tab-content="lilypond-png" class="tab-content hidden flex-1 flex flex-col p-4">
                        <div id="lilypond-render-container" class="flex-1 bg-white p-3 border-2 border-gray-300 rounded overflow-auto flex items-center justify-center">
                            <p class="text-gray-500 text-sm">LilyPond rendering</p>
                        </div>
                    </div>

                    <!-- Ephemeral Model Tab (full document with state) -->
                    <div id="tab-content-ephemeral" data-tab-content="ephemeral" class="tab-content hidden flex-1 flex flex-col p-4">
                        <h3 class="text-sm font-semibold mb-2 text-gray-700">Ephemeral Model (includes runtime state)</h3>
                        <pre id="document-json" class="flex-1 text-xs font-mono bg-white p-3 border-2 border-gray-300 rounded overflow-auto"></pre>
                    </div>

                    <!-- Persistent Model Tab (saveable content only) -->
                    <div id="tab-content-persistent" data-tab-content="persistent" class="tab-content hidden flex-1 flex flex-col p-4">
                        <h3 class="text-sm font-semibold mb-2 text-gray-700">Persistent Model (saved to disk)</h3>
                        <pre id="persistent-json" class="flex-1 text-xs font-mono bg-white p-3 border-2 border-gray-300 rounded overflow-auto"></pre>
                    </div>

                    <!-- Console Errors Tab -->
                    <div id="tab-content-console-errors" data-tab-content="console-errors" class="tab-content hidden flex-1 flex flex-col p-4">
                        <h3 class="text-sm font-semibold mb-2">Console Errors</h3>
                        <div id="console-errors-list" class="flex-1 space-y-1 overflow-auto text-xs bg-white p-3 border-2 border-gray-300 rounded">
                            <div class="text-sm text-gray-500">No errors</div>
                        </div>
                    </div>

                    <!-- Console Log Tab -->
                    <div id="tab-content-console-log" data-tab-content="console-log" class="tab-content hidden flex-1 flex flex-col p-4">
                        <h3 class="text-sm font-semibold mb-2">Console Log</h3>
                        <div id="console-log-list" class="flex-1 space-y-1 overflow-auto text-xs bg-white p-3 border-2 border-gray-300 rounded">
                            <div class="text-sm text-gray-500">No logs</div>
                        </div>
                    </div>

                    <!-- HTML Tab -->
                    <div id="tab-content-html" data-tab-content="html" class="tab-content hidden flex-1 flex flex-col p-4">
                        <h3 class="text-sm font-semibold mb-2 text-gray-700">Rendered HTML Structure</h3>
                        <pre id="html-content" class="flex-1 text-xs font-mono bg-white p-3 border-2 border-gray-300 rounded overflow-auto"></pre>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- JavaScript Modules -->
    <script type="module" src="dist/main.js"></script>
</body>
</html>